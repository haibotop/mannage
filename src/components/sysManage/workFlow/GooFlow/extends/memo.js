/**
 * GooFlow-Vue - Web端流程设计器
 * @author foolegg126 (sdlddr)
 * @version v1.2.0
 * @license Commercially licensed to 永凯软件技术(上海)有限公司-913101157867305734(imclouds)
 **/
import EventAgent from"../common/EventAgent";import Calc from"../common/Calc";export default{flag:"memo",events:{onMemoSetText:null},methods:{_initMemo(){if(!this.prop.$editable)return;EventAgent(this.$refs.$paper,"contextmenu",".GooFlow_memo",{inthis:this},function(e,t){let o=e.data.inthis;if("function"==typeof o.onItemRightClick&&!1===o.onItemRightClick(t.id,"memo"))return Calc.preventDefault(e),!1});let e=this;this.$refs.$paper.addEventListener("mousedown",function(t){if(2===t.button)return!1;if("memo"!==e.prop.$nowType)return;if("none"!==e.$refs.$textArea.style.display)return;if(t||(t=window.event),"memo_text"===t.target.className)return;let o=Calc.getRealStyle(t.target).cursor,s=t.target.parentNode;switch(o){case"nw-resize":case"w-resize":case"n-resize":s=s.parentNode;break;case"move":break;default:return}t.id=s.id,e.$refs.$ghost.css({cursor:o});let i=e.prop.$memos[s.id];e._bindMoveEvent(t,i,function(t,o,i,r,p,n,h){t&&("move"!==i?e.resizeMemo(s.id,n,h):e.moveMemo(s.id,r,p))},o,140,54)}),EventAgent(this.$refs.$paper,"dblclick",".GooFlow_memo .memo_text",{inthis:this},function(t,o){if("memo"!==e.prop.$nowType)return;t||(t=window.event);let s=o.parentNode.parentNode;if("function"==typeof e.onItemDbClick&&!1===e.onItemDbClick(s.id,"memo"))return;let i=t.target.innerHTML,r=parseInt(s.style.left,10)+10*e.scale,p=parseInt(s.style.top,10),n=e.t;return e.$refs.$textArea.value=i,e._renameTxtShow({width:o.offsetWidth+10*e.scale,height:o.offsetHeight+20*e.scale,left:n.left+r-e.$refs.$workArea.parentNode.scrollLeft,top:n.top+p-e.$refs.$workArea.parentNode.scrollTop}),e.$refs.$textArea.dataset.id=s.id,e.$refs.$textArea.focus(),e.$refs.$workArea.parentNode.onmouseup=function(t){e.$refs.$workArea.parentNode.onmouseup=null,2!==t.button&&"block"===e.$refs.$textArea.style.display&&(e.setMemoText(e.$refs.$textArea.dataset.id,e.$refs.$textArea.value),e.$refs.$textArea.value="",e.$refs.$textArea.dataset.id=void 0,e.$refs.$textArea.style.display="none")},Calc.stopEventPop(t),!1}),this.$refs.$paper.addEventListener("mouseup",function(t){if("block"===e.$refs.$textArea.style.display)return e.setMemoText(e.$refs.$textArea.dataset.id,e.$refs.$textArea.value),e.$refs.$textArea.value="",e.$refs.$textArea.dataset.id=void 0,void(e.$refs.$textArea.style.display="none");if("memo"===e.prop.$nowType){switch(t||(t=window.event),t.target.className){case"rs_close":return e.delMemo(t.target.parentNode.parentNode.id),Calc.stopEventPop(t),!1;case"memo_text":case"memo_body":return}if(!e.prop.$dragAddOper&&"none"===e.$refs.$ghost.$el.style.display){if(2===t.button)return Calc.stopEventPop(t),!1;let o=Calc.mouseP(t),s=Calc.elCsys(this),i=o.x-s.left+this.parentNode.parentNode.scrollLeft,r=o.y-s.top+this.parentNode.parentNode.scrollTop;return e.addMemo((new Date).getTime(),{text:"",left:i/e.scale,top:r/e.scale,width:140,height:54}),Calc.stopEventPop(t),!1}}})},addMemo(e,t,o,s,i,r){!1!==o&&"function"==typeof this.onItemAdd&&!1===this.onItemAdd(e,"memo",t)||("function"==typeof this.pushOper&&!s&&this.prop.$editable&&this.pushOper("delMemo",[e]),this.prop.$editable&&(t.alt=!0,this.prop.$deletedItem[e]&&delete this.prop.$deletedItem[e]),r?this.prop.$memos[e]=t:this.$set(this.prop.$memos,e,t),++this.prop.$memoCount,!i&&this.prop.$navMap&&this.$nextTick(function(){this.refreshMap()}))},delMemo(e,t,o,s){this.prop.$memos[e]&&(!1!==t&&"function"==typeof this.onItemDel&&!1===this.onItemDel(e,"memo")||("function"!=typeof this.pushOper||o||this.pushOper("addMemo",[e,this.prop.$memos[e]]),this.prop.$editable&&(this.prop.$deletedItem[e]="memo"),this.$delete(this.prop.$memos,e),--this.prop.$memoCount,!s&&this.prop.$navMap&&this.$nextTick(function(){this.refreshMap()})))},moveMemo(e,t,o){if(!this.prop.$memos[e])return;if(null!=this.onItemMove&&!this.onItemMove(e,"memo",t,o))return;"function"==typeof this.pushOper&&this.pushOper("moveMemo",[e,this.prop.$memos[e].left,this.prop.$memos[e].top]),t<0&&(t=0),o<0&&(o=0);let s=this.prop.$memos[e];s.left=t,s.top=o,this.prop.$editable&&(s.alt=!0);let i=document.getElementById(e);i.style.left=t*this.scale+"px",i.style.top=o*this.scale+"px",this.prop.$navMap&&this.$nextTick(function(){this.refreshMap()})},resizeMemo(e,t,o){if(!this.prop.$memos[e])return;if("function"==typeof this.onItemResize&&!1===this.onItemResize(e,"memo",t,o))return;"function"==typeof this.pushOper&&this.pushOper("resizeMemo",[e,this.prop.$memos[e].width,this.prop.$memos[e].height]);let s=document.getElementById(e);s.childNodes[0].style.width=t*this.scale+"px",s.childNodes[0].style.height="auto";let i=s.offsetHeight;(o*=this.scale)<i&&(o=i),s.childNodes[0].style.height=o+"px";let r=this.prop.$memos[e];r.width=t,r.height=o/this.scale,this.prop.$editable&&(r.alt=!0),this.$set(this.prop.$memos[e],r),this.prop.$navMap&&this.$nextTick(function(){this.refreshMap()})},setMemoText(e,t){if(!this.prop.$memos[e])return;if(this.prop.$memos[e].text===t)return;if("function"==typeof this.onMemoSetText&&!1===this.onMemoSetText(e,t))return;let o=this.prop.$memos[e],s=this.prop.$memos[e].text;o.text=t;let i=document.getElementById(e);i.querySelector(".memo_text").innerHTML=t,i.childNodes[0].style.height="auto";let r=i.offsetWidth/this.scale,p=i.offsetHeight/this.scale;p<o.height&&(p=o.height),i.childNodes[0].style.height=p*this.scale+"px",o.width===r&&o.height===p||this.resizeMemo(e,r,p),this.prop.$editable&&(o.alt=!0),this.$set(this.prop.$memos[e],o),"function"==typeof this.pushOper&&this.pushOper("setMemoText",[e,s])}}};