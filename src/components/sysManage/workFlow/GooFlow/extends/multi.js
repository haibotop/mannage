/**
 * GooFlow-Vue - Web端流程设计器
 * @author foolegg126 (sdlddr)
 * @version v1.2.0
 * @license Commercially licensed to 永凯软件技术(上海)有限公司-913101157867305734(imclouds)
 **/
import Class from"../common/Class";import Calc from"../common/Calc";Object.keys=Object.keys||function(t){let e=[];for(let o in t)t.hasOwnProperty(o)&&e.push(o);return e};export default{flag:"multi",prop:{$multiNodes:{},$multiLines:{},$multiKey:"shift"},events:{onBatchAdd:null,onBatchDel:null,onBatchMove:null,onBatchMark:null},methods:{_isMultiKey(t){return!(!t.shiftKey||"shift"!==this.prop.$multiKey)||!(!t.ctrlKey||"ctrl"!==this.prop.$multiKey)},_wallAllMulti(){if(!this.prop.$multiNodes||!this.prop.$multiLines)return;if(0===Object.keys(this.prop.$multiNodes).length&&0===Object.keys(this.prop.$multiLines).length)return this.$refs.$multiGhost.hide(),void this.$refs.$multiOper.hide();let t=0,e=0,o=-1,i=-1;for(let l in this.prop.$multiNodes){let s=this.prop.$nodes[l];(-1===o||s.left<o)&&(o=s.left),(-1===i||s.top<i)&&(i=s.top),s.width+s.left>t&&(t=s.width+s.left),s.height+s.top>e&&(e=s.height+s.top)}for(let l in this.prop.$multiLines){let s=this.prop.$lines[l],r=document.getElementById(l),p=r.getAttribute("from").split(","),n=[];n[0]=parseFloat(p[0]),n[1]=parseFloat(p[1]);let h=r.getAttribute("to").split(","),u=[];u[0]=parseFloat(h[0]),u[1]=parseFloat(h[1]),"sl"===s.type||("tb"===s.type?(n[1]=s.M,u[1]=s.M):"lr"===s.type&&(n[0]=s.M,u[0]=s.M)),(-1===o||n[0]<o)&&(o=n[0]),(-1===o||u[0]<o)&&(o=u[0]),(-1===i||n[1]<i)&&(i=n[1]),(-1===i||u[1]<i)&&(i=u[1]),n[0]>t&&(t=n[0]),u[0]>t&&(t=u[0]),n[1]>e&&(e=n[1]),u[1]>e&&(e=u[1])}this.$refs.$multiGhost.show({left:o-2+"px",top:i-2+"px",width:t-o+4+"px",height:e-i+4+"px"}),this.$refs.$multiOper.show({left:t+4+"px",top:i-2+"px"})},_addtoMultiList(t,e,o){let i=null;"node"===e?(this.prop.$multiNodes[t]=t,i=document.getElementById(t),Class.addClass(i,"item_focus"),i.style.borderColor=this.GooFlow.color.line):"line"===e&&(this.prop.$multiLines[t]=t,(i=document.getElementById(t).querySelector("path[stroke-linecap='round']")).setAttribute("stroke","#ff8800"),this.prop.$lines[t].noArrow||i.setAttribute("marker-end","url(#arrow2)")),o&&this._wallAllMulti()},_removeFromMultiList(t,e,o){let i=null,l=null;if("node"===e){delete this.prop.$multiNodes[t],i=document.getElementById(t),Class.removeClass(i,"item_focus"),l=this.prop.$nodes[t];const e=this.prop.$nodeTypeMap[l.type]||l.type;l.marked?(Class.addClass(i,"item_mark"),i.style.borderColor=this.GooFlow.color.mark):e.indexOf(" mix")>0?i.style.borderColor=this.GooFlow.color.mix:this.prop.$nodeCustoms[e]?i.style.borderColor="transparent":i.style.borderColor=this.prop.$nodes[t].color||this.GooFlow.color.node}else"line"===e&&(delete this.prop.$multiLines[t],l=this.prop.$lines[t],i=document.getElementById(t).querySelector("path[stroke-linecap='round']"),l.marked||(i.setAttribute("stroke",l.color||this.GooFlow.color.line),l.noArrow||i.setAttribute("marker-end","url(#arrow1)")));o&&this._wallAllMulti()},_clearMultiList(){for(let t in this.prop.$multiNodes)this._removeFromMultiList(t,"node");for(let t in this.prop.$multiLines)this._removeFromMultiList(t,"line");this._wallAllMulti()},_initMultiSelect(t){let e=this;e.prop.$multiKey=t,this.$refs.$workArea.addEventListener("mousedown",function(t){let o={X:0,Y:0};if("cursor"!==e.prop.$nowType)return;if(e._isMultiKey(t))return!1;if(e.$refs.$multiGhost.inShow()){if(0===Object.keys(e.prop.$multiLines).length&&0===Object.keys(e.prop.$multiNodes).length)return void e._wallAllMulti();let i=e.$refs.$multiGhost.position(),l=e.$refs.$multiGhost.offsetSize();if(!((o=Calc.getCoor(t,this)).X<i.left||o.X>i.left+l.width||o.Y<i.top||o.Y>i.top+l.height))return l.left=i.left,l.top=i.top,void e._bindMoveEvent(t,l,function(t,e,o,i,s){t&&e.batchMove(e.prop.$multiNodes,e.prop.$multiLines,i-l.left,s-l.top),e._wallAllMulti()});{let i=t.target,l=i.tagName;if(!("svg"===l||"DIV"===l&&i.className.indexOf("GooFlow_work")>-1||"LABEL"===l))return;e.$refs.$multiGhost.show({left:o.X+"px",top:o.Y+"px",width:"0px",height:"0px"}),e.$refs.$multiOper.hide()}}else{let i=t.target,l=i.tagName;if(!("svg"===l||"DIV"===l&&i.className.indexOf("GooFlow_work")>-1||"LABEL"===l))return;o=Calc.getCoor(t,this),e.$refs.$multiGhost.show({left:o.X+"px",top:o.Y+"px",width:"0",height:"0"}),e.$refs.$multiOper.hide()}let i=!1;document.onmousemove=function(t){t||(t=window.event);let l=Calc.getCoor(t,e.$refs.$workArea),s=l.X-o.X,r=l.Y-o.Y,p=e.$refs.$multiGhost.position();s<0&&(p.left=o.X+s,s*=-1),r<0&&(p.top=o.Y+r,r*=-1),i=!0,e.$refs.$multiGhost.css({left:p.left+"px",top:p.top+"px",width:s+"px",height:r+"px"})},document.onmouseup=function(){document.onmousemove=null,document.onmouseup=null;let o=e.$refs.$multiGhost.position(),l=e.$refs.$multiGhost.offsetSize(),s=o.left,r=o.top,p=l.width,n=l.height;""!==e.prop.$focus&&e.blurItem(!1),e._clearMultiList(),i&&(e.$nextTick(function(){for(let t in e.prop.$nodes){let o=e.prop.$nodes[t],i={left:o.left*e.scale,top:o.top*e.scale,right:(o.left+o.width)*e.scale,bottom:(o.top+o.height)*e.scale},l=i.left>=s&&i.left<=s+p||i.right>=s&&i.right<=s+p,h=i.top>=r&&i.top<=r+n||i.bottom>=r&&i.bottom<=r+n;if(!l||!h){let t=i.left<=s&&i.right>=s+p&&(r<=i.top&&r+n>=i.top||r<=i.bottom&&r+n>=i.bottom),e=i.top<=r&&i.bottom>=r+n&&(s<=i.left&&s+p>=i.left||s<=i.right&&s+p>=i.right);if(!t&&!e)continue}e._addtoMultiList(t,"node")}for(let t in e.prop.$lines){let o,i,l,h=e.prop.$lines[t],u=document.getElementById(t),f=u.getAttribute("from").split(","),m=[];m[0]=parseFloat(f[0]),m[1]=parseFloat(f[1]);let c=u.getAttribute("to").split(","),$=[];$[0]=parseFloat(c[0]),$[1]=parseFloat(c[1]),"sl"===h.type||("tb"===h.type?(m[1]=h.M,$[1]=h.M):"lr"===h.type&&(m[0]=h.M,$[0]=h.M)),o=m[0]>=s&&m[0]<=s+p&&m[1]>=r&&m[1]<=r+n,i=$[0]>=s&&$[0]<=s+p&&$[1]>=r&&$[1]<=r+n,(o||i||("tb"===h.type?l=r<=$[1]&&$[1]<=r+n&&(m[0]<=s&&$[0]>=s+p||$[0]<=s&&m[0]>=s+p):"lr"===h.type&&(l=s<=$[0]&&$[0]<=s+p&&(m[1]<=r&&$[1]>=r+n||$[1]<=r&&m[1]>=r+n)),l))&&e._addtoMultiList(t,"line")}e._wallAllMulti()}),Calc.stopEventPop(t))}})},batchMarkItem(t,e,o){if("function"!=typeof this.onBatchMark||!1!==this.onBatchMark(t,e,o)){if("object"==typeof t&&"number"==typeof t.length&&t.length>0)for(let e=0;e<t.length;++e)this.markItem(t[e],o,!1,!0,!0);if("object"==typeof e&&"number"==typeof e.length&&e.length>0)for(let t=0;t<e.length;++t)this.markItem(e[t],o,!1,!0,!0);"function"==typeof this.pushOper&&this.pushOper("batchMarkItem",[t,e,o]),this.prop.$navMap&&this.$nextTick(function(){this.refreshMap()})}},batchAddItem(t,e){if("function"==typeof this.onBatchAdd&&!1===this.onBatchAdd(t,e))return;let o=[],i=[];for(let e in t)this.addNode(e,t[e],!1,!0,!0),i.push(e);for(let t in e)this.addLine(t,e[t],!1,!0,!0),o.push(t);"function"==typeof this.pushOper&&this.prop.$editable&&this.pushOper("batchDelete",[i,o]),this.prop.$navMap&&this.$nextTick(function(){this.refreshMap()})},batchDelete(t,e){if("function"==typeof this.onBatchDel&&!1===this.onBatchDel(t,e))return;let o={},i={};if("object"==typeof t&&"number"==typeof t.length&&t.length>0)for(let e=0;e<t.length;++e)if(this.prop.$nodes[t[e]]&&null!=this.prop.$nodes[t[e]]){i[t[e]]=JSON.parse(JSON.stringify(this.prop.$nodes[t[e]]));for(let i in this.prop.$lines)this.prop.$lines[i].from!==t[e]&&this.prop.$lines[i].to!==t[e]||(o[i]=JSON.parse(JSON.stringify(this.prop.$lines[i])),this.delLine(i,!1,!0,!0),this.prop.$multiLines&&delete this.prop.$multiLines[i]);this.delNode(t[e],!1,!0,!0),this.prop.$multiNodes&&delete this.prop.$multiNodes[t[e]]}if("object"==typeof e&&"number"==typeof e.length&&e.length>0)for(let t=0;t<e.length;++t)this.prop.$lines[e[t]]&&null!=this.prop.$lines[e[t]]&&(o[e[t]]=JSON.parse(JSON.stringify(this.prop.$lines[e[t]])),this.delLine(e[t],!1,!0,!0),this.prop.$multiLines&&delete this.prop.$multiLines[e[t]]);"function"==typeof this.pushOper&&this.prop.$editable&&this.pushOper("batchAddItem",[i,o]),this.prop.$navMap&&this.$nextTick(function(){this.refreshMap()})},batchMove(t,e,o,i){if(0===Object.keys(t).length&&0===Object.keys(e).length)return;if("number"!=typeof o||"number"!=typeof i)return;if("function"==typeof this.onBatchMove&&!1===this.onBatchMove(t,e,o,i))return;let l={},s={};if("object"==typeof t)for(let e in t){let t=this.prop.$nodes[e];t&&null!=t&&(this.moveNode(e,t.left+o,t.top+i,!1,!0,!0),l[e]=e)}if("object"==typeof e)for(let t in e){let e=this.prop.$lines[t];e&&null!=e&&("lr"!==e.type&&"tb"!==e.type||(this.setLineM(t,"lr"===e.type?o+e.M:i+e.M,!0,!1,!0),s[t]=t))}"function"==typeof this.pushOper&&this.prop.$editable&&this.pushOper("batchMove",[l,s,-1*o,-1*i]),this.prop.$navMap&&this.$nextTick(function(){this.refreshMap()})}}};