/**
 * GooFlow-Vue - Web端流程设计器
 * @author foolegg126 (sdlddr)
 * @version v1.2.0
 * @license Commercially licensed to 永凯软件技术(上海)有限公司-913101157867305734(imclouds)
 **/
import canvasExtend from"../common/canvasExtend";import Calc from"../common/Calc";import Class from"../common/Class";let Cmder={canvasExtend:function(){canvasExtend()},initBg:function(t,e,o){let l=document.createElement("canvas");l.width=t,l.height=e;let i=l.getContext("2d");return o&&(i.fillStyle=o),i.fillRect(0,0,l.width,l.height),i.save(),l},_toNum:function(t){return null!==t&&""!==t?parseInt(t.split("px")[0],10):void 0},_analyseLabel:function(t){let e=t.tagName,o=t.offsetLeft,l=t.offsetTop,i=null;if("TD"===e){let e=t.querySelector("div"),r=Calc.getRealStyle(e);o+=e.offsetLeft-this._toNum(r.marginLeft),l+=e.offsetTop-this._toNum(r.marginTop),i=r.transform}else i=t.style.transform;let r=Calc.getRealStyle(t),n=this._toNum(r.lineHeight),a=r.fontSize;return{isMemo:!!Class.hasClass(t,"memo_text")||void 0,font:"14px "+r.fontFamily,fontFamily:r.fontFamily,fontSize:this._toNum(a.split("px")[0]),text:t.innerText,color:r.color,width:t.offsetWidth,height:t.offsetHeight,transform:i,lineHeight:n,offsetLeft:o,offsetTop:l,lineNum:Math.ceil(t.offsetHeight/n)}},_analyseIcon:function(t){let e=Calc.getRealStyle(t),o=e.backgroundImage,l={offsetLeft:t.offsetLeft,offsetTop:t.offsetTop,width:t.offsetWidth,height:t.offsetHeight};return o&&"none"!==o?(o=o.replace(/"/g,"").split("url(")[1],l.backgroundImage=o.substr(0,o.length-1),o=e.backgroundPosition.split(" "),l.pX=-1*parseFloat(o[0].split("px")[0]),l.pY=-1*parseFloat(o[1].split("px")[0]),l.offsetLeft=t.parentNode.offsetLeft,l.offsetTop=t.parentNode.offsetTop):Object.assign(l,{font:"18px "+e.fontFamily.split(" ")[0],lineHeight:this._toNum(e.lineHeight),color:e.color,opacity:parseFloat(e.opacity),content:window.getComputedStyle(t,"::before").getPropertyValue("content")}),l},_fillIcon:function(t,e,o,l,i,r){let n=t.getContext("2d");if(void 0===l.backgroundImage){0===l.content.indexOf('"')&&(l.content=l.content.split('"')[1]),l.color=l.color.replace("rgb","rgba").replace(")",", "+l.opacity+")"),n.fillStyle=l.color,n.font=l.font,n.textAlign="center",n.textBaseline="middle";let t=window.ActiveXObject||"ActiveXObject"in window?0:1,i=e+l.offsetLeft+4+l.width/2+t,a=o+l.offsetTop+2+l.height/2+t;return n.save(),n.translate(i,a),n.scale(r,r),n.fillText(l.content,0,0),n.restore(),null}{n.save();let t=0,a=0;l.pX<0&&(t-=l.pX,l.pX=0),l.pY<0&&(a-=l.pY,l.pY=0);let s=l.isCustom?0:2*r;n.drawImage(i,l.pX,l.pY,l.width,l.height,e+l.offsetLeft+s+t,o+l.offsetTop+s+a,l.width*r,l.height*r),n.restore()}},_fillLabel:function(t,e,o,l,i,r){let n=t.getContext("2d");n.fillStyle=l.color,n.textAlign="center",l.isMemo&&(n.textAlign="left"),n.font=l.font,n.textBaseline="top";let a=l.text,s=0,d=0,h=window.ActiveXObject||"ActiveXObject"in window?1:3,f=e+l.offsetLeft+(l.isMemo?0:l.width/2)+h/2,c=o+l.offsetTop+h;r&&(f-=r.x,c+=r.y),navigator.userAgent.indexOf("Firefox")>=0&&(c+=l.lineHeight-l.fontSize),n.save(),n.translate(f,c),c=0,f=0,n.scale(i,i);for(let t=0;t<a.length;t++)s+=n.measureText(a[t]).width,t!==a.length-1?s>=l.width/i&&(n.fillText(a.substring(d,t),f,c),c+=l.lineHeight,s=0,d=t):n.fillText(a.substring(d,t+1),f,c);n.restore()},_analyseArea:function(t){let e=t.querySelector(".bg"),o=Calc.getRealStyle(e);return{top:this._toNum(t.style.top),left:this._toNum(t.style.left),width:t.offsetWidth,height:t.offsetHeight,borderColor:o.borderTopColor,bgColor:o.backgroundColor,opacity:parseFloat(o.opacity),icon:this._analyseIcon(t.querySelector("i")),label:this._analyseLabel(t.querySelector("label"))}},renderAreas:function(t,e,o,l){let i=t.getContext("2d");for(let r in e){let n=e[r];n.bgColor=n.bgColor.replace("rgb","rgba").replace(")",", "+n.opacity+")"),n.borderColor=n.borderColor.replace("rgb","rgba").replace(")",", "+n.opacity+")"),i.fillStyle=n.bgColor,i.strokeStyle=n.borderColor,i.rect(n.left,n.top,n.width,n.height),i.fill(),i.stroke(),this._fillIcon(t,n.left-3,n.top-3,n.icon,o,l),this._fillLabel(t,n.left,n.top,n.label,l)}},_analyseMemo:function(t){let e=this._analyseIcon(t.querySelector("i"));e.font="14px "+e.font.split(" ")[1];let o=this._analyseLabel(t.querySelector(".memo_text"));o.font="12px "+o.fontFamily;let l=Calc.getRealStyle(t);return{top:this._toNum(t.style.top),left:this._toNum(t.style.left),width:t.offsetWidth,height:t.offsetHeight,bgColor:l.color,boxShadow:l.boxShadow,icon:e,label:o}},renderMemos:function(t,e,o){let l=t.getContext("2d");for(let i in e){let r=e[i];l.save(),l.fillStyle=r.bgColor;let n=r.boxShadow.split(") ");l.shadowColor=n[0],n=n[1].split(" "),l.shadowOffsetX=this._toNum(n[0]),l.shadowOffsetY=this._toNum(n[1]),l.shadowBlur=this._toNum(n[2]),l.beginPath(),l.moveTo(r.left+10,r.top),l.lineTo(r.left+r.width,r.top),l.lineTo(r.left+r.width,r.top+r.height),l.lineTo(r.left,r.top+r.height),l.lineTo(r.left,r.top+10),l.lineTo(r.left+10,r.top),l.closePath(),l.fill(),l.restore(),l.save(),l.fillStyle="rgba(0,0,0,0.1)",l.beginPath(),l.moveTo(r.left+10,r.top),l.lineTo(r.left+10,r.top+10),l.lineTo(r.left,r.top+10),l.lineTo(r.left+10,r.top),l.closePath(),l.fill(),l.restore(),l.save(),l.fillStyle=r.icon.color,l.font=r.icon.font,l.textAlign="center",l.textBaseline="middle";let a=r.left+r.width/2,s=r.top+2;l.translate(a,s),l.scale(o,o),0===r.icon.content.indexOf('"')&&(r.icon.content=r.icon.content.split('"')[1]),l.fillText(r.icon.content,0,0),l.restore(),this._fillLabel(t,r.left,r.top,r.label,o)}},_analyseNode:function(t){let e="";Class.hasClass(t,"item_ellipse")&&(e="ellipse"),Class.hasClass(t,"item_rhomb")&&(e="rhomb"),Class.hasClass(t,"item_round")&&(e="round"),Class.hasClass(t,"item_parallelogram")&&(e="parallelogram"),Class.hasClass(t,"item_custom")&&(e="custom");let o=Calc.getRealStyle(t),l={top:this._toNum(t.style.top),left:this._toNum(t.style.left),width:t.offsetWidth,height:t.offsetHeight,borderColor:o.borderTopColor,borderWidth:this._toNum(o.borderTopWidth),bgColor:o.backgroundColor,borderRadius:this._toNum(o.borderTopLeftRadius),boxShadow:o.boxShadow,spClass:e,icon:this._analyseIcon(t.querySelector(".ico").childNodes[0])};return Class.hasClass(t,"item_round")||Class.hasClass(t,"item_rhomb")||Class.hasClass(t,"item_custom")?l.label=this._analyseLabel(t.querySelector(".span")):l.label=this._analyseLabel(t.querySelector("td").nextSibling),"custom"===e&&(l.icon.isCustom=!0),l},renderNodes:function(t,e,o,l){let i=t.getContext("2d");for(let r in e){let n=e[r],a=n.boxShadow.split(") ");if(1===a.length){let t=n.boxShadow.split("rgba");a[0]="rgba"+t[1],a[1]=t[0]}"custom"!==n.spClass&&(i.shadowColor=a[0],a=a[1].split(" "),i.shadowOffsetX=this._toNum(a[0])+(n.borderWidth>1?1:0),i.shadowOffsetY=this._toNum(a[1])+(n.borderWidth>1?1:0),i.shadowBlur=this._toNum(a[2])),i.fillStyle=n.bgColor,"ellipse"===n.spClass?i.BezierEllipse(n.left+n.width/2,n.top+n.height/2,n.width/2,n.height/2).fill():"rhomb"===n.spClass?(i.save(),i.translate(n.left+n.width/2,n.top+n.height/2),i.rotate(45*Math.PI/180),i.roundRect(-n.width/2,-n.height/2,n.width-n.borderWidth,n.height-n.borderWidth,n.borderRadius).fill(),i.restore()):"parallelogram"===n.spClass?(i.save(),i.translate(n.left+n.width/2,n.top+n.height/2),i.transform(1,0,-12/n.height,1,0,0),i.roundRect(-n.width/2,-n.height/2,n.width-n.borderWidth,n.height-n.borderWidth,n.borderRadius).fill(),i.restore()):"custom"===n.spClass||i.roundRect(n.left+n.borderWidth/2,n.top+n.borderWidth/2,n.width-n.borderWidth,n.height-n.borderWidth,n.borderRadius).fill(),i.shadowBlur=0,i.shadowColor="",i.shadowOffsetX=0,i.shadowOffsetY=0,i.strokeStyle=n.borderColor,i.lineWidth=0===n.borderWidth?.01:n.borderWidth,i.stroke(),this._fillIcon(t,n.left+(n.borderRadius>6?-3:0),n.top,n.icon,o,l),this._fillLabel(t,n.left,n.top,n.label,l,"rhomb"===n.spClass?{x:n.width/3*1.41,y:n.height/4}:void 0)}},_analyseLine:function(t,e){let o=Calc.getRealStyle(t).fontFamily,l=e.querySelector("path[stroke-linecap]"),i=l.getAttribute("marker-end"),r={color:l.getAttribute("stroke"),lineWidth:l.getAttribute("stroke-width"),lineCap:"round",noArrow:!i||null==i},n=l.style.strokeDasharray;r.lineDash=n&&null!=n;let a=e.childNodes[2],s=a.getAttribute("fill");s&&null!==s&&""!==s||(s="#777"),r.label={text:a.textContent,font:a.style.fontSize+" "+o,color:s,left:a.getAttribute("x"),top:a.getAttribute("y")};let d=l.getAttribute("d"),h=d.substring(2,d.length).split(/[L|Q]/),f=[];for(let t=0;t<h.length;++t){h[t]=h[t].replace(/^\s+|\s+$/gm,"");let e=h[t].split(" ");2===e.length?f.push({x:parseFloat(e[0]),y:parseFloat(e[1])}):f.push({x:parseFloat(e[0]),y:parseFloat(e[1]),dX:parseFloat(e[2]),dY:parseFloat(e[3])})}r.points=f;let c=f.length,g=f[c-1].x-f[c-2].x,u=f[c-1].y-f[c-2].y;return r.angle=Math.atan2(u,g),r},renderLines:function(t,e){let o=t.getContext("2d");for(let l in e){let i=e[l];o.save(),o.setLineDash(i.lineDash?[4,6]:[]),o.strokeStyle=i.color,o.lineWidth=i.lineWidth,o.lineCap=i.lineCap;let r=i.points;o.beginPath(),o.moveTo(r[0].x,r[0].y);for(let t=1;t<r.length;++t)if(r[t].dX){let e=r[t].y===r[t].dY?Math.abs(r[t].x-r[t].dX):Math.abs(r[t].y-r[t].dY);o.arcTo(r[t].x,r[t].y,r[t].dX,r[t].dY,e),o.moveTo(r[t].dX,r[t].dY)}else o.lineTo(r[t].x,r[t].y),t!==r.length-1&&o.moveTo(r[t].x,r[t].y);if(o.closePath(),o.stroke(),i.noArrow||(o.translate(r[r.length-1].x,r[r.length-1].y),o.rotate(i.angle),o.fillStyle=i.color,o.beginPath(),o.moveTo(1*i.lineWidth,0),o.lineTo(-6*i.lineWidth,-3*i.lineWidth),o.lineTo(-6*i.lineWidth,3*i.lineWidth),o.lineTo(1*i.lineWidth,0),o.closePath(),o.fill()),o.restore(),i.label&&null!=i.label.text&&""!=i.label.text){let e=t.getContext("2d"),o=i.label;e.fillStyle=o.color,e.textAlign="center",e.font=o.font,e.fillText(o.text,o.left,o.top)}}}};function exportFileStream(t,e,o){try{let l=new Blob([t]);if(window.navigator.msSaveOrOpenBlob)navigator.msSaveBlob(l,e+"."+o);else{let t=document.createElement("a");t.href=window.URL.createObjectURL(l),t.download=e+"."+o,t.click(),window.URL.revokeObjectURL(t.href)}}catch(l){let i=window.open("","_blank");for(;"complete"!==i.document.readyState&&"complete"!==i.document.readyState;);i.document.write("<html><head><title>"+e+"."+o+"</title></head><body><pre>"+("xml"===o?t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"):t)+"</pre></body></html>")}}export default{flag:"export",initFuncName:"canvasExtend",methods:{canvasExtend(){Cmder.canvasExtend()},exportDiagram(t){let e=void 0,o=null,l={},i=this.$refs.$group.querySelectorAll(".GooFlow_area");for(let t=0;t<i.length;++t)l[i[t].id]=Cmder._analyseArea(i[t]),l[i[t].id].icon.backgroundImage&&null===o&&(o=l[i[t].id].icon.backgroundImage);let r={},n=this.$refs.$paper.querySelectorAll(".GooFlow_memo");for(let t=0;t<n.length;++t)r[n[t].id]=Cmder._analyseMemo(n[t]);let a={},s=this.$refs.$workArea.querySelectorAll(".GooFlow_item");for(let t=0;t<s.length;++t)a[s[t].id]=Cmder._analyseNode(s[t]),a[s[t].id].icon.backgroundImage&&null===o&&(o=a[s[t].id].icon.backgroundImage);let d=this._suitSize(),h=d.width+100*this.scale,f=d.height+100*this.scale,c=Cmder.initBg(h,f,"#ffffff"),g=this;null!==o&&((e=new Image).setAttribute("crossOrigin","anonymous"),e.src=o);let u=function(){i.length>0&&Cmder.renderAreas(c,l,e,g.scale),n.length>0&&Cmder.renderMemos(c,r,g.scale),Cmder.renderNodes(c,a,e,g.scale);let o=c.getContext("2d");if(o.restore(),window.ActiveXObject||"ActiveXObject"in window||navigator.userAgent.indexOf("Edge")>-1){let e={},o=this.$refs.$draw.querySelectorAll("g");for(let t=0;t<o.length;++t)"GooFlow_tmp_line"!==o[t].getAttribute("tid")&&(e[o[t].id]=Cmder._analyseLine(g.$el,o[t]));Cmder.renderLines(c,e);try{let e=c.msToBlob();navigator.msSaveBlob(e,t+".png")}catch(e){let o=c.toDataURL("image/png"),l=window.open("","_blank");for(;"complete"!==l.document.readyState&&"complete"!==l.document.readyState;);l.document.write("<html><head><title>"+t+'.png</title></head><body><img src="'+o+'" border="1" title="'+t+'.png"></body></html>')}}else{let e='<svg xmlns="http://www.w3.org/2000/svg" width="'+h+'" height="'+f+'"><defs><style type="text/css">text{font-size:14px;line-height:1.42857143;font-family:"Microsoft Yahei", "Helvetica Neue", Helvetica, Hiragino Sans GB, WenQuanYi Micro Hei, Arial, sans-serif;}</style></defs>'+g.$refs.$draw.innerHTML+"</svg>",l=new Image;l.src="data:image/svg+xml,"+encodeURIComponent(e),l.onload=function(){o.drawImage(l,0,0);let e=document.createElementNS("http://www.w3.org/1999/xhtml","a");e.href=c.toDataURL("image/png"),e.download=t+".png",document.body.appendChild(e),e.click(),document.body.removeChild(e)}}};!e||e.complete||window.ActiveXObject||"ActiveXObject"in window?u():e.onload=function(){u()}},exportDataFile(t,e){if("json"===e)exportFileStream(JSON.stringify(this.exportData()),t,"json");else{if("xml"!==e)return;try{exportFileStream(this.exportBpmnXML(),t,"xml")}catch(t){console.warn("failed in exec function exportBpmnXML()! you need extend the xml.js plugin for supported.")}}}}};