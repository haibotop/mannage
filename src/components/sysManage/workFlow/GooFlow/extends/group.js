/**
 * GooFlow-Vue - Web端流程设计器
 * @author foolegg126 (sdlddr)
 * @version v1.2.0
 * @license Commercially licensed to 永凯软件技术(上海)有限公司-913101157867305734(imclouds)
 **/
import EventAgent from"../common/EventAgent";import Calc from"../common/Calc";export default{flag:"group",methods:{_initGroup(){if(!this.prop.$editable)return;EventAgent(this.$refs.$group,"contextmenu",".GooFlow_area",{inthis:this},function(e,t){let r=e.data.inthis;if("function"==typeof r.onItemRightClick&&!1===r.onItemRightClick(t.id,"area"))return Calc.preventDefault(e),!1});let e=this;this.$refs.$group.addEventListener("mousedown",function(t){if(2===t.button)return!1;if("group"!==e.prop.$nowType)return;if("none"!==e.$refs.$textArea.style.display)return;if(t||(t=window.event),"LABEL"===t.target.tagName||"I"===t.target.tagName)return;let r=Calc.getRealStyle(t.target).cursor,a=t.target.parentNode;switch(r){case"nw-resize":case"w-resize":case"n-resize":a=a.parentNode;break;case"move":break;default:return}a=a.id,t.id=a,e.$refs.$ghost.css({cursor:r});let s=e.prop.$areas[a];e._bindMoveEvent(t,s,function(t,r,s,o,i,p,n){t&&("move"!==s?e.resizeArea(a,p,n):e.moveArea(a,o,i))},r,200,100)}),this.$refs.$group.addEventListener("dblclick",function(t){if("group"!==e.prop.$nowType)return;if(t||(t=window.event),"LABEL"!==t.target.tagName)return Calc.stopEventPop(t),!1;let r=t.target.parentNode;if("function"==typeof e.onItemDbClick&&!1===e.onItemDbClick(r.id,"area"))return;let a=t.target.innerHTML,s=parseInt(r.style.left,10)+18,o=parseInt(r.style.top,10)+1,i=e.t;return e.$refs.$textArea.value=a,e._renameTxtShow({width:130,height:26,left:i.left+s-e.$refs.$workArea.parentNode.scrollLeft,top:i.top+o-e.$refs.$workArea.parentNode.scrollTop}),e.$refs.$textArea.dataset.id=r.id,e.$refs.$textArea.focus(),e.$refs.$workArea.parentNode.onmouseup=function(t){e.$refs.$workArea.parentNode.onmouseup=null,2!==t.button&&"block"===e.$refs.$textArea.style.display&&(e.setName(e.$refs.$textArea.dataset.id,e.$refs.$textArea.value,"area"),e.$refs.$textArea.value="",e.$refs.$textArea.dataset.id=void 0,e.$refs.$textArea.style.display="none")},Calc.stopEventPop(t),!1}),this.$refs.$group.addEventListener("mouseup",function(t){if("none"!==e.$refs.$textArea.style.display)return e.setName(e.$refs.$textArea.dataset.id,e.$refs.$textArea.value,"area"),e.$refs.$textArea.value="",e.$refs.$textArea.dataset.id=void 0,void(e.$refs.$textArea.style.display="none");if("group"===e.prop.$nowType){switch(t||(t=window.event),t.target.className){case"rs_close":return e.delArea(t.target.parentNode.parentNode.id),Calc.stopEventPop(t),!1;case"bg":return}switch(t.target.tagName){case"LABEL":return Calc.stopEventPop(t),!1;case"I":let r=t.target.parentNode.id;switch(e.prop.$areas[r].color){case"red":e.setAreaColor(r,"yellow");break;case"yellow":e.setAreaColor(r,"blue");break;case"blue":e.setAreaColor(r,"green");break;case"green":e.setAreaColor(r,"milk");break;case"milk":e.setAreaColor(r,"red")}return Calc.stopEventPop(t),!1}if(!e.prop.$dragAddOper&&"none"===e.$refs.$ghost.$el.style.display){if(2===t.button)return Calc.stopEventPop(t),!1;let r=Calc.mouseP(t),a=Calc.elCsys(this),s=r.x-a.left+this.parentNode.parentNode.scrollLeft,o=r.y-a.top+this.parentNode.parentNode.scrollTop,i=["red","yellow","blue","green","milk"];return e.addArea((new Date).getTime(),{name:e.prop.$areaPrefix+e.prop.$max,left:s/e.scale,top:o/e.scale,color:i[e.prop.$max%5],width:200,height:100}),e.prop.$max++,Calc.stopEventPop(t),!1}}})},_areaFixNodes(e){let t=this.prop.$areas[e];for(let r in this.prop.$nodes){let a=this.prop.$nodes[r];a.left>=t.left&&a.left<t.left+t.width&&a.top>=t.top&&a.top<t.top+t.height?a.areaId=e:a.areaId&&a.areaId===e&&this._node2Area(r)}},addArea(e,t,r,a,s,o){!1!==r&&"function"==typeof this.onItemAdd&&!1===this.onItemAdd(e,"area",t)||("function"==typeof this.pushOper&&!a&&this.prop.$editable&&this.pushOper("delArea",[e]),this.prop.$editable&&(t.alt=!0,this.prop.$deletedItem[e]&&delete this.prop.$deletedItem[e]),o?this.prop.$areas[e]=t:this.$set(this.prop.$areas,e,t),this.prop.$editable&&this._areaFixNodes(e),++this.prop.$areaCount,!s&&this.prop.$navMap&&this.$nextTick(function(){this.refreshMap()}))},delArea(e,t,r,a){if(this.prop.$areas[e]&&(!1===t||"function"!=typeof this.onItemDel||!1!==this.onItemDel(e,"area"))){if("function"!=typeof this.pushOper||r||this.pushOper("addArea",[e,this.prop.$areas[e]]),this.prop.$editable){for(let t in this.prop.$nodes){let r=this.prop.$nodes[t];r.areaId===e&&delete r.areaId}this.prop.$deletedItem[e]="area"}this.$delete(this.prop.$areas,e),--this.prop.$areaCount,!a&&this.prop.$navMap&&this.$nextTick(function(){this.refreshMap()})}},moveArea(e,t,r){if(!this.prop.$areas[e])return;if(null!=this.onItemMove&&!this.onItemMove(e,"area",t,r))return;"function"==typeof this.pushOper&&this.pushOper("moveArea",[e,this.prop.$areas[e].left,this.prop.$areas[e].top]),t<0&&(t=0),r<0&&(r=0);let a=this.prop.$areas[e];a.left=t,a.top=r,this.prop.$editable&&(a.alt=!0,this._areaFixNodes(e));let s=document.getElementById(e);s.style.left=t*this.scale+"px",s.style.top=r*this.scale+"px",this.prop.$navMap&&this.$nextTick(function(){this.refreshMap()})},setAreaColor(e,t){this.prop.$areas[e]&&("red"!==t&&"yellow"!==t&&"blue"!==t&&"green"!==t&&"milk"!==t||("function"==typeof this.pushOper&&this.pushOper("setAreaColor",[e,this.prop.$areas[e].color]),this.prop.$editable&&(this.prop.$areas[e].alt=!0),this.$set(this.prop.$areas[e],"color",t),this.prop.$navMap&&this.$nextTick(function(){this.refreshMap()})))},resizeArea(e,t,r){if(!this.prop.$areas[e])return;if("function"==typeof this.onItemResize&&!1===this.onItemResize(e,"area",t,r))return;"function"==typeof this.pushOper&&this.pushOper("resizeArea",[e,this.prop.$areas[e].width,this.prop.$areas[e].height]);let a=document.getElementById(e);a.childNodes[0].style.width=t*this.scale+"px",a.childNodes[0].style.height=r*this.scale+"px",t=a.offsetWidth,r=a.offsetHeight;let s=this.prop.$areas[e];s.width=t,s.height=r,this.prop.$editable&&(s.alt=!0,this._areaFixNodes(e)),this.$set(this.prop.$areas[e],s),this.prop.$navMap&&this.$nextTick(function(){this.refreshMap()})}}};