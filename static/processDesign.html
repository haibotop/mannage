<!DOCTYPE html>
<html>

<head>
  <meta name="viewport" content="width=device-width" />
  <title>创建流程图</title>
  <link rel="stylesheet" type="text/css" href="workFlow/codebase/GooFlow.css" />
  <link rel="stylesheet" href="workFlow/codebase/base.css" />
  <link rel="stylesheet" href="workFlow/codebase/onLine2.css" />


  <script src="workFlow/codebase/jquery.min.js"></script>
  <script type="text/javascript" src="workFlow/codebase/GooFunc.js"></script>
  <script type="text/javascript" src="workFlow/codebase/json2.js"></script>
  <script type="text/javascript" src="workFlow/codebase/GooFlow.js"></script>
  <script type="text/javascript" src="workFlow/codebase/GooFlow.color.js"></script>


  <!-- <script src="workFlow/codebase/svg.min.js"></script> -->
  <script src="workFlow/codebase/onLine.js"></script>
  <script src="workFlow/codebase/workflow.js"></script>
  <script src="WebConfig.js"></script>
</head>

<body>
  <div class="cover"></div>
  <div class="nodeId"></div>
  <div class="topSet">
    <p class="processName"></p>
    <button type="button" class="btn btn-primary btn-xs processBtn" onclick="submit()">保存</button>
    <button type="button" class="back btn btn-primary btn-xs processBtn">撤销</button>
  </div>
  <!-- 工作流连线的弹框 -->
  <div id="test" data-pair=10000 class="lineBox pt10">
    <p class="showTitle">订单信息-导入导出字段对应设置</p>
    <div class="show cb">
      <div class="workLeft">
        <span>单据</span>
        <select class="combobox" id="select1">
          <option>-请选择-</option>
          <option value="Order">订单信息</option>
          <option value="Work">工作信息</option>
          <option value="Item">物品信息</option>
          <option value="Resource">资源信息</option>
        </select>
        <!-- 源租户 -->
        <span>源租户</span>
        <select class="combobox" id="Tenant">
          <option>-请选择-</option> 
        </select>
        <span>字段</span>
        <select class="combobox" id="showLeftInfo">
        </select>
      </div>
      <div class="workLeft">
          <span>单据</span>
        <select class="combobox" id="select2">
          <option>-请选择-</option>
          <option value="Order">订单信息</option>
          <option value="Work">工作信息</option>
          <option value="Item">物品信息</option>
          <option value="Resource">资源信息</option>
          <option value="MessageData">消息</option>
        </select>
        <!-- 目标租户 -->
        <span>目标租户</span>
        <select class="combobox" id="ToTenant">
          <option>-请选择-</option>
        </select>
        <span>字段</span>
        <select class="combobox" id="showrightInfo"></select>
      </div>
      <div class="commit">新增</div>
      <div class="edit">
        <label class="conditions" for="select4">条件</label>
        <input type="text" class="combobox3" id="select4" placeholder="请输入条件">
        
      </div>
      <ul class="tableTitle">
          <li> 源租户</li>
          <li>目标租户</li>
          <li> 操作</li>
        </ul>
      <div id="tableDiv">
        <table id="workTable">

        </table>
      </div>

    </div>
    <div class="tools">
      <div class="getPair">确定</div>
      <div class="hidPair">取消</div>
    </div>
  </div>
  <div id="demo" style="margin:0;float:left;width: 100% !important;height: 96% !important"></div>
  <div style="clear:both; display: none;">
    <input id="submit" type="button" value='导出结果' onclick="Export()" />
    <textarea id="result" row="6"></textarea>
  </div>
  <div class="btnBox" style="clear:both; ">
  </div>
  <!--排程操作弹窗-->
  <div id="operation" data-pair=10000 class="lineBox pt10" style="display: none;">
    <p class="showTitle">排程操作弹窗</p>
    <div class="show cb">

      <div class="body">
        <div class="rowDiv">
          <span class="rowSpan">模块</span>
          <select class="opSelect" id="ModularSelect">
            <option>-请选择模块-</option>
          </select>
        </div>
        <div class="rowDiv">
          <span class="rowSpan">单据</span>
          <select class="opSelect" id="BillSelect">
            <option>-请选择单据-</option>
          </select>
        </div>
        <div class="rowDiv">
          <span class="rowSpan">操作</span>
          <select class="opSelect" id="operationSelect">
            <option>-请选择操作-</option>
          </select>
        </div>
        <div class="rowDiv">
          <span class="rowSpan">排程方案</span>
          <select class="opSelect" id="schedulingSelect">
            <option>-请选择操作-</option>
          </select>
        </div>
      </div>

    </div>
    <div class="tools">
      <div class="operationOK">确定</div>
      <div class="operationCancel">取消</div>
    </div>
  </div>
  <!--发消息（短信，邮件）-->
  <div id="sendMessage" data-pair=10000 class="lineBox pt10" style="display: none;">
    <p class="showTitle">发送消息/邮件</p>
    <div class="show cb">

      <div class="body">
        <div class="rowDiv">
          <span class="rowSpan">类型</span>
          <select class="opSelect" id="sendMessageType">
            <option value="0">邮件</option>
            <option value="1">短信</option>
          </select>
        </div>
        <div class="rowDiv">
          <span class="rowSpan">标题</span>
          <input class="opSelect" type="input" name="sendMessageTitle" id="sendMessageTitle">
        </div>
        <div class="rowDiv">
          <span class="rowSpan">接收客户</span>
          <select class="opSelect" id="sendMessageSelect">
          </select>
        </div>
        <div class="rowDiv">
          <span class="rowSpan">客户昵称</span>
          <input type="text" name="nickname" class="opSelect" id="nickname" disabled="disabled">
        </div>
        <div class="rowDiv">
          <span class="rowSpan">正文内容</span>
          <textarea rows="5" style="max-width: 80%;width:70%;max-height:350px;vertical-align: middle;" id="sendMessageContent"></textarea>
        </div>
      </div>

    </div>
    <div class="tools">
      <div class="sendMessageOK">确定</div>
      <div class="sendMessageCancel">取消</div>
    </div>
    
  </div>
</body>

</html>
<script type="text/javascript">
  //左侧工具栏
  var property = {
    toolBtns: ["start round", "end round", "task round", "node", "chat", "state", "plug", "join", "fork",
      "complex mix"
    ],
    haveHead: true,
    //如果haveHead=true，则定义HEAD区的按钮
    headBtns: ["new", "open", "save", "undo", "redo", "reload"],
    haveTool: true,
    haveGroup: true,
    useOperStack: true
  };
  //左侧工具栏鼠标提示
  var remark = {
    cursor: "选择指针",
    direct: "结点连线",
    start: "入口结点",
    "end": "结束结点",
    "task": "任务结点",
    node: "自动结点",
    chat: "决策结点",
    state: "状态结点",
    plug: "附加插件",
    fork: "分支结点",
    "join": "联合结点",
    "complex mix": "复合结点",
    group: "组织划分框编辑开关"
  };
  var token = localStorage.getItem('userToken'); //从列表页获取的token
  var ModularSelectTemp = ""; //模块下拉框数据
  var operationData = []; //排程操作弹窗数据
  var sendMessageData = []; //发送消息接口
  var abbreviationData = []; //昵称
  var demo;
  var rightId = "";
  var getItemId;
  var getData;
  var getRightId;
  var getRightData;
  var canvas;
  var nodeList = {
    // item: [],
    // node: '',
    data: [],
    workFlowData: []
  }
  var leftData = []
  var rightData = []
  var arr = []
  $(document).ready(function () {
    demo = $.createGooFlow($("#demo"), property);
    demo.setNodeRemarks(remark);
    //移除控件
    demo.onItemDel = function (id, type) {
      if (confirm("确定要删除该单元吗?")) {
        var ItemData = localStorage.getItem("data");
        if (ItemData == '{data":[],"workFlowData":[]}') {
          return true;
        } else {
          var nodeItem = $.parseJSON(ItemData)
          if (nodeItem.data.length <= 0) {
            localStorage.setItem("data", JSON.stringify(nodeItem));
          } else if (nodeItem.data.length > 0) {
            for (let j = 0; j < nodeItem.data.length; j++) {
              if (nodeItem.data[j].Name == "排程" && nodeItem.data[j].InParameters.Params.Id == id) {
                for (let k = 0; k < operationData.length; k++) {
                  if (operationData[k].Id == id) {
                    operationData.splice(k, 1)
                  }
                }
                nodeItem.data.splice(j, 1)
                localStorage.setItem("data", JSON.stringify(nodeItem));
              } else
              if (nodeItem.data[j].Name == "发送消息" && nodeItem.data[j].InParameters.Params.Id == id) {
                for (let k = 0; k < sendMessageData.length; k++) {
                  if (sendMessageData[k].Id == id) {
                    sendMessageData.splice(k, 1)
                  }
                }
                nodeItem.data.splice(j, 1)
                localStorage.setItem("data", JSON.stringify(nodeItem));
              } else {

              }
            }
          }
          if (nodeItem.workFlowData.length <= 0) {

          } else if (nodeItem.workFlowData.length > 0) {

            for (let i = 0; i < nodeItem.workFlowData.length; i++) {
              if (nodeItem.workFlowData[i].id == id) {
                nodeItem.workFlowData.splice(i, 1)
                localStorage.setItem("data", JSON.stringify(nodeItem));
              }
            }

          }
          return true;

        }
      } else {
        return false;
      }
    }
    //加载节点数据
    var Id = "Id,==," + checkId + ",And";
    var data2 = {
      "Name": "YWF_BusinessFlowNode",
      "DefaultVal": "Search",
      "Filter": Id
    }
    var forData = JSON.stringify(data2);
    $.ajax({
      url: Yukon.StaticUrl.Bus,
      type: "post",
      dataType: 'json',
      data: {
        "name": Yukon.ServiceName.Workflow,
        "operation": "GetJsonData",
        "token": token,
        "reqInfo": forData
      },
      success: function (returnValue) {
        // console.log(returnValue)
        var result = returnValue;
        if (!!result.data.FlowData) {
          var datas = $.parseJSON(result.data.FlowData);
          getData = datas;
          var NodeData = getData.NodeData;
          demo.loadData(NodeData);
          var BusinessData = $.parseJSON(result.data.BusinessData);
          for (let i in BusinessData) {
            if (BusinessData[i].Name == "单据流转") {
              nodeList.workFlowData.push(BusinessData[i].InParameters.Params)
            }
            if (BusinessData[i].Name == "排程") {
              operationData.push(BusinessData[i].InParameters.Params)
              nodeList.data.push(BusinessData[i])
            }
            if (BusinessData[i].Name == "发送消息") {
              sendMessageData.push(BusinessData[i].InParameters.Params)
              nodeList.data.push(BusinessData[i])
            }
          }
          localStorage.setItem('data', JSON.stringify(nodeList));
        } else {
          nodeList.data = []
          nodeList.workFlowData = []
          localStorage.setItem('data', JSON.stringify(nodeList));
        }
      },
      error: function (returnValue) {
        alert("对不起！数据加载失败！");
      }
    })  
    //工单流转
    function listData() {
      var tblName2 = getRightData.TriggerState;
      //赋值左边
      var tblName = getRightData.Bill;
      // 赋值右边
      var tblName1 = getRightData.ToBill;
      $("#select1").val(tblName);
      $("#select2").val(tblName1);
      $("#select4").val(tblName2);
      $("#Tenant").val(getRightData.Tenant);
      $("#ToTenant").val(getRightData.ToTenant);
      leftList()
      rightList()
      setTimeout(function(){
        workflowList(false)
      },200)
    }
    var chatOpotion = false
    //鼠标右键操作节点
    demo.onItemRightClick = function (id, type) {
      rightId = id;
      localStorage.setItem("rightId", rightId);
      obj = this.$nodeData[id]; //获取到选中了哪些
      if (obj.type == "plug") { //判断是否是工作流——页面为插头
        $('#test').css("display", "block")
        $(".cover").show();
        
        //如果有Item的值就取Item里的值 没有的话就从本地缓存获取
        getWorkData = $.parseJSON(localStorage.getItem("data")).workFlowData;
        if (getWorkData) { //如果存入缓存的接口数据不为空就取接口数据，否则就取之前存入缓存的数据
          for (var i = 0; i < getWorkData.length; i++) {
            if (getWorkData[i].id == id) {
              arr = []
              getRightId = getWorkData[i].id; 
              getRightData = getWorkData[i];
              arr = getWorkData[i].DataMap.PropertyValueMap
            }
          }
          if (getRightId != id) {
            $('#select1').val('-请选择-');
            $('#select2').val('-请选择-');
            $('#select4').attr("value");
            $('#Tenant').val('-请选择-');
            $('#ToTenant').val('-请选择-'); 
            $("#showLeftInfo").val('-请选择-');
            $("#showrightInfo").val('-请选择-');
            arr = []
            workflowList(false)
          } else {
            listData()
          }
        }
      }
      if (obj.type == "node") { //判断是否是排程——页面展示为齿轮
        $('#operation').css("display", "block")
        $(".cover").show();
        if (ModularSelectTemp == "") { //判断模块下拉框是否有数据
          getSchedulingSelect();
          getOperationSelect();
        }
        let oldValue = false;
        if (operationData.length > 0) {
          for (let i in operationData) { //匹配值
            if (rightId == operationData[i].Id) {
              oldValue = true;
              childSelect(operationData[i].Module);
              setTimeout(function () {
                $('#ModularSelect').val(operationData[i].Module); //模块
                $('#BillSelect').val(operationData[i].Bill); //单据
                $('#operationSelect').val(operationData[i].Operation); //操作
                getSchedulingSelect(operationData[i].CMD);
                $('#schedulingSelect').val(operationData[i].CMD); //排程方案
              }, 100);
            }
          }
          if (!oldValue) { //初始化
            var ModularSelectValue = $('#ModularSelect option:first').val();
            $('#ModularSelect').val(ModularSelectValue);
            childSelect(); //获取单据操初始化数据
            var cmdFirst = $('#schedulingSelect option:first').val()
            $('#schedulingSelect').val(cmdFirst); //排程方案
          }

        }
      }
      if (obj.type == "chat") { //判断是否是发送消息/邮件——页面展示为消息

        $('#sendMessage').css("display", "block"); //显示弹窗
        $(".cover").show(); //遮罩层
        getSendMessageUseList(); //获取客户下拉列表
        let oldValue = false;
        if (sendMessageData.length > 0) {
          for (let i in sendMessageData) { //匹配值
            if (rightId == sendMessageData[i].Id) {
              oldValue = true
              $('#sendMessageType').val(sendMessageData[i].Type);
              $('#sendMessageTitle').val(sendMessageData[i].Title);
              setTimeout(function () {
                $('#sendMessageSelect').val(sendMessageData[i].username);
              }, 100)

              $('#nickname').val(sendMessageData[i].ContentList[0]);
              $("#sendMessageContent").val(sendMessageData[i].ContentList[1]);
            }
          }
          if (!oldValue) { //初始化
            var checkValueType = $('#sendMessageType option:first').val();
            $('#sendMessageType').val(checkValueType);
            $('#sendMessageTitle').val("");
            var checkValueSelect = $('checkValueSelect option:first').val();
            $('#sendMessageSelect').val(checkValueSelect);
            $("#sendMessageContent").val("");  
            getNickName(); //获取昵称值
          }
        }

      }
    }
  });
  //排程弹窗的下拉框数据
  function getOperationSelect() {
    var ModularData = {
      "Name": "EventFilter",
      "EnumField": "Module",
      "DefaultVal": "SearchEnum",
    }
    var modularReqInfoData = JSON.stringify(ModularData);
    $.ajax({
      url: Yukon.StaticUrl.Bus,
      type: "Post",
      dataType: 'json',
      data: {
        "name": Yukon.ServiceName.Workflow,
        "operation": "GetJsonData",
        "token": token,
        "reqInfo": modularReqInfoData
      },
      success: function (returnValue) {
        var data = returnValue;
        var datas = data.data;
        ModularSelectTemp = datas;
        for (var i = 0; i < datas.length; i++) {
          html = "<option value=" + datas[i].key + ">" + datas[i].value + "</option>";
          $("#ModularSelect").append(html);
        }
      },
      error: function (returnValue) {
        alert("对不起！数据加载失败！");
      }
    })
  }
  $("#ModularSelect").change(function () {
    childSelect();
  });
  $('.commit').click(function() {
    workflowList(true)
  })
  //获取排程单据操作下拉框
  function childSelect(val) {
    var parentID = ""
    if (val != null) {
      parentID = val
    } else {
      parentID = $("#ModularSelect").val()
    }
    if (parentID == "" || parentID == null) {
      alert("请选择模块")
    } else {
      /**单据**/
      var BillData = {
        "Name": "EventFilter",
        "EnumField": "Bill",
        "DefaultVal": "SearchEnum",
        "Id": parentID
      }
      var billReqInfoData = JSON.stringify(BillData);
      $.ajax({
        url: Yukon.StaticUrl.Bus,
        type: "Post",
        dataType: 'json',
        data: {
          "name": Yukon.ServiceName.Workflow,
          "operation": "GetJsonData",
          "token": token,
          "reqInfo": billReqInfoData
        },
        success: function (returnValue) {
          var data = returnValue;
          var datas = data.data;
          $("#BillSelect").html(""); //清空缓存
          let html = "";
          for (var i = 0; i < datas.length; i++)  {
            html += "<option value=" + datas[i].key + ">" + datas[i].value + "</option>";
          }
          $("#BillSelect").append(html);
        },
        error: function (returnValue) {
          alert("对不起！数据加载失败！");
        }
      })
      /**操作**/
      var operationData = {
        "Name": "EventFilter",
        "EnumField": "Operation",
        "DefaultVal": "SearchEnum",
        "Id": parentID
      }
      var operationReqInfoData = JSON.stringify(operationData);
      $.ajax({
        url: Yukon.StaticUrl.Bus,
        type: "Post",
        dataType: 'json',
        data: {
          "name": Yukon.ServiceName.Workflow,
          "operation": "GetJsonData",
          "token": token,
          "reqInfo": operationReqInfoData
        },
        success: function (returnValue) {
          var data = returnValue;
          var datas = data.data;
          $("#operationSelect").html(""); //清空缓存
          let html = "";
          for (var i = 0; i < datas.length; i++) {
            html += "<option value=" + datas[i].key + ">" + datas[i].value + "</option>";
          }
          $("#operationSelect").append(html);
        },
        error: function (returnValue) {
          alert("对不起！数据加载失败！");
        }
      })
    }
  }
  //获取排程方案下拉框
  function getSchedulingSelect(val) {
    var dataparams1 = {
      "Name": "ApsParam",
      "Filter": "",
      "PageSize": 20,
      "CurrentPage": 1,
      "SortCondition": "",
      "Properties": []
    }
    var data1 = JSON.stringify(dataparams1) //转成json字符串
    $.ajax({
      url: Yukon.StaticUrl.Bus,
      type: "Post",
      dataType: 'json',
      data: {
        "name": Yukon.ServiceName.APS,
        "operation": "GetJsonData",
        "token": token,
        "reqInfo": data1
      },
      success: function (returnValue) {
        var datas = returnValue.data.nodes;
        $("#schedulingSelect").html(""); //清空缓存
        let html = "";
        for (var i = 0; i < datas.length; i++) {
          html += "<option value=" + datas[i].label + ">" + datas[i].label + "</option>";
        }
        $("#schedulingSelect").append(html);
        $('#schedulingSelect').val(val); //排程方案
      },
      error: function (returnValue) {
        alert("对不起！数据加载失败！");
      }
    });
  }
  var receiveConnect = ''
  // 发送消息客户下拉框
  function getSendMessageUseList() {
    var data = {
      "Name": "TMP_CstInformation",
      "Properties": [
        "Id",
        "Code",
        "Name",
        "Email",
        "Mobile",
        "Abbreviation"
      ],
      "SortCondition": {
        "CreateTime": "DESC"
      },
      "PageSize": 1000,
      "DefaultVal": "SearchAll"
    };
    var str = JSON.stringify(data);
    $.ajax({
      url: Yukon.StaticUrl.Bus,
      type: "post",
      dataType: 'json',
      data: {
        "name": Yukon.ServiceName.Tenant,
        "operation": "GetJsonData",
        "token": token,
        "reqInfo": str
      },
      success: function (returnValue) {
        chatOpotion = true
        var data = returnValue;
        receiveConnect = data.data
        var datas = data.data;
        if (datas.length > 0) {
          for (var i = 0; i < datas.length; i++) {
            var objTem = {};
            objTem[datas[i].PropertyValueMap.Id] = datas[i].PropertyValueMap.Abbreviation
            abbreviationData.push(objTem);
            html = "<option value=" + datas[i].PropertyValueMap.Id + ">" + datas[i].PropertyValueMap.Name +
              "</option>";
            $("#sendMessageSelect").append(html);
          }
        }
        $("#nickname").attr("value", datas[0].PropertyValueMap.Abbreviation); //昵称
      },
      error: function (returnValue) {
        alert("对不起！数据加载失败！");
      }
    });
  };
  //排程弹窗确定
  $(".operationOK").click(function () {
    let operationValue = false
    for (let i in operationData) { 
      if (operationData[i].Id == rightId) {
        operationValue = true;
        operationData[i].Module = $("#ModularSelect").val();
        operationData[i].Bill = $("#BillSelect").val();
        operationData[i].Operation = $("#operationSelect").val();
        operationData[i].CMD = $("#schedulingSelect").val();
      }
    }
    if (!operationValue) {
      var data = {
        Module: $("#ModularSelect").val(),
        Bill: $("#BillSelect").val(),
        Operation: $("#operationSelect").val(),
        Id: rightId,
        CMD: $("#schedulingSelect").val()
      };
      operationData.push(data);
    }
    $('#operation').css("display", "none")
    $('.cover').hide();
  });

  //排程弹窗取消
  $(".operationCancel").click(function () {
    $('#operation').css("display", "none");
    $('.cover').hide()
  });
  //发送消息接收客户发生改变
  $("#sendMessageSelect").change(function () {
    getNickName();
  });
  //消息确定
  $(".sendMessageOK").click(function () {
    let sendOldValue = false;
    var connect = []
    var userName = ''
    if (sendMessageData.length > 0) {
      for (let i in sendMessageData) {
        if (sendMessageData[i].Id == rightId) {
          sendOldValue = true;
          sendMessageData[i].Type = $("#sendMessageType").val();
          sendMessageData[i].Title = $("#sendMessageTitle").val();
          for (let j = 0; j < receiveConnect.length; j++) {
            if (receiveConnect[j].PropertyValueMap.Id == $("#sendMessageSelect").val()) {
              sendMessageData[i]['username'] = receiveConnect[j].PropertyValueMap.Id
              if ($("#sendMessageType").val() == 0) {
                connect.push(receiveConnect[j].PropertyValueMap.Email)
              } else if ($("#sendMessageType").val() == 1) {
                connect.push(receiveConnect[j].PropertyValueMap.Mobile)
              } else {
                connect = []
              }

            }
          }
          sendMessageData[i].ContentList = [
            $("#nickname").val(), //用户昵称（用于发短信）
            $("#sendMessageContent").val(), //消息内容（用于发短信、邮件）
          ];
          sendMessageData[i].ReceiverList = connect;
        }
      }
    }
    if (!sendOldValue) {
      for (let j = 0; j < receiveConnect.length; j++) {
        if (receiveConnect[j].PropertyValueMap.Id == $("#sendMessageSelect").val()) {
          if ($("#sendMessageType").val() == 0) {
            connect.push(receiveConnect[j].PropertyValueMap.Email)
          } else if ($("#sendMessageType").val() == 1) {
            connect.push(receiveConnect[j].PropertyValueMap.Mobile)
          } else {
            connect = []
          }

        }
      }
      var data = {
        Id: rightId,
        Type: $("#sendMessageType").val(), //0:邮件；1：短信
        Title: $("#sendMessageTitle").val(), //（用于发邮件）
        ContentList: [
          $("#nickname").val(), //用户昵称（用于发短信）
          $("#sendMessageContent").val() //消息内容（用于发短信、邮件）
        ],
        ReceiverList: connect,
        username: $("#sendMessageSelect").val() //接收客户（用于发短信）
      };
      sendMessageData.push(data);
    }
    $('#sendMessage').css("display", "none");
    $('.cover').hide();
  });
  //消息取消
  $(".sendMessageCancel").click(function () {
    $('#sendMessage').css("display", "none");
    $('.cover').hide()
  });

  function getNickName() {
    var userID = $("#sendMessageSelect").val();
    for (var i in abbreviationData) {
      for (var j in abbreviationData[i]) {
        if (j == userID) {
          $('#nickname').val(abbreviationData[i][j]);
          $("#nickname").attr("value", abbreviationData[i][j]); //昵称
        }
      }
    }
  }

</script>
<script type="text/javascript">
  $('#operation').css("display", "none"); //默认排程操作弹窗不显示
  $('#sendMessage').css("display", "none"); //发送消息
  $('.cover').click(function () {
    $('.cover').hide()
    $('#test').css("display", "none");
    $('#operation').css("display", "none");
    $('#sendMessage').css("display", "none");
  })
  //保存
  function submit(argument) {
    addProcess()
  }
  // var analysisName = localStorage.getItem("Name");
  var checkId = localStorage.getItem("processCheckId");
  var checkName = localStorage.getItem("processCheckName");
  // $('.processName').html(analysisName); //把流程名称渲染到页面
  //保存流程图
  function addProcess() {
    //获取的节点对象
    var processData = demo.exportData(); //节点对象
    var FlowData = {
      "NodeData": processData, //节点数据
    }
    var data = $.parseJSON(localStorage.getItem('data')).workFlowData;
    var workFlow = []
    //单据流转
    if ('undefined' != typeof (data) && data.length > 0) { //业务流转
      for (let i in data) {
        let temp = {
          "Name": "单据流转",
          "InParameters": {
            "Params": data[i]
          }
        }
        workFlow.push(temp);
      }
    }
    //排程
    if ('undefined' != typeof (operationData) && operationData.length > 0) { //操作
      for (let i in operationData) {
        let temp = {
          "Name": "排程",
          "InParameters": {
            "Params": operationData[i]
          }
        }
        workFlow.push(temp);
      }
    }
    //发送消息
    if ('undefined' != typeof (sendMessageData) && sendMessageData.length > 0) {
      for (let i in sendMessageData) {
        let temp = {
          "Name": "发送消息",
          "InParameters": {
            "Params": sendMessageData[i]
          }
        }
        workFlow.push(temp);
      }
    }
    let dataTemp = {
      "FlowData": FlowData,
      "BusinessData": workFlow,
    }
    var data2 = {
      "Name": "YWF_BusinessFlowNode",
      "PropertyValueMap": {
        "Id": checkId,
        "Name": checkName
      },
      "DefaultVal": "NewSave",
      "Data": dataTemp,
    }

    var forData = JSON.stringify(data2);
    $.ajax({
      url: Yukon.StaticUrl.Bus,
      type: "post",
      dataType: 'json',
      data: {
        "name": Yukon.ServiceName.Workflow,
        "operation": "SetJsonData",
        "token": token,
        "data": forData

      },
      success: function (returnValue) {
        console.log(returnValue)
        alert("提交成功");
        window.parent.iframeClose();
      },
      error: function (returnValue) {
        alert("对不起！数据加载失败！");
      }
    })
  }

  function leftList() {
    var tblName = $("#select1").val()
    var reqInfo = {
      "Name": "DBField",
      "TblName": tblName,
      "Tag": "全部",
      "Pagesize":'100',
      "Properties": ["Code", "Name", "BelongTbl", "EngCode", "EditType", "ShowCode"]
    }
    var data2 = JSON.stringify(reqInfo) //转成json字符串
    $.ajax({
      url: Yukon.StaticUrl.Bus,
      type: "post",
      dataType: 'json',
      data: {
        "name": Yukon.ServiceName.APS,
        "operation": "GetJsonData",
        token: token,
        reqInfo: data2
      },
      success: function (returnValue) {
        $("#showLeftInfo").empty();
        var data = returnValue.data;
        for (let i = 0; i < data.length; i++) {
          if (data[i].PropertyValueMap.ShowCode == "内部ID") {
            data.splice(i, 1)
          }
        }
        leftData = data
        $.each(data, function (k, v) {
          s = "<option value=" + v.PropertyValueMap.EngCode + ">" + v.PropertyValueMap.ShowCode +
            "</option>"
          $("#showLeftInfo").append(s);
        });
      },
      error: function (returnValue) {
        alert("对不起！数据加载失败！");
      }
    })
  }
  //切换下拉框是获取左侧列表
  $("#select1").change(function () {
    $('#workTable').empty()
    arr = []
    leftList()
    
  });

  //切换下拉框是获取右侧列表
  function rightList() {
    var tblName1 = $("#select2").val()
    var reqInfo = {
      "Name": "DBField",
      "TblName": tblName1,
      "Tag": "全部",
      "Pagesize":'100',
      "Properties": ["Code", "Name", "BelongTbl", "EngCode", "EditType", "ShowCode"]
    }
    var data2 = JSON.stringify(reqInfo) //转成json字符串
    $.ajax({
      url: Yukon.StaticUrl.Bus,
      type: "post",
      dataType: 'json',
      data: {
        "name": Yukon.ServiceName.APS,
        "operation": "GetJsonData",
        token: token,
        reqInfo: data2
      },
      success: function (returnValue) {
        $("#showrightInfo").empty();
        var data = returnValue.data;
        rightData = data
        for (let i = 0; i < data.length; i++) {
          if (data[i].PropertyValueMap.ShowCode == "内部ID") {
            data.splice(i, 1)
          }
        }
        $.each(data, function (k, v) {
          s = "<option value=" + v.PropertyValueMap.EngCode + ">" + v.PropertyValueMap.ShowCode +
            "</option>"
          $("#showrightInfo").append(s);
        });
      },
      error: function (returnValue) {
        alert("对不起！数据加载失败");
      }
    })
  }
  $("#select2").change(function () {
    $('#workTable').empty()
    arr = []
    rightList()
    
  });
  function workflowList(type) {
    $('#test').workflowList(type)
  }

</script>

<style type="text/css">
  /**********操作弹窗开始******/


  .body {
    width: 100%;
    margin-left: 5%;
  }


  /********操作弹窗结束*********/

</style>
